---
import BaseLayout from './BaseLayout.astro';
import SEO from '../components/SEO.astro';
import AdSense from '../components/AdSense.astro';

interface Props {
  title: string;
  description: string;
  publishDate: string;
  category: string;
  tags?: string[];
  faq?: { q: string; a: string }[];
  headings: { depth: number; slug: string; text: string }[];
}

const { title, description, publishDate, category, tags, faq, headings } = Astro.props;

const tocHeadings = faq && faq.length > 0
  ? [...headings.filter(h => h.depth === 2), { depth: 2, slug: 'faq', text: 'Frequently Asked Questions' }]
  : headings.filter(h => h.depth === 2);

const formattedDate = new Date(publishDate).toLocaleDateString('en-US', {
  year: 'numeric', month: 'long', day: 'numeric'
});
---

<BaseLayout>
  <SEO slot="head" title={title} description={description} />

  <!-- Article Schema -->
  <script slot="head" type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": title,
    "description": description,
    "datePublished": publishDate,
    "author": { "@type": "Organization", "name": "FreeToolkit" },
    "publisher": { "@type": "Organization", "name": "FreeToolkit" },
  })} />

  <!-- Breadcrumb Schema -->
  <script slot="head" type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://calc.freetoolkit.cc" },
      { "@type": "ListItem", "position": 2, "name": "Blog", "item": "https://calc.freetoolkit.cc/blog/" },
      { "@type": "ListItem", "position": 3, "name": title },
    ],
  })} />

  {/* FAQ Schema */}
  {faq && faq.length > 0 && (
    <script slot="head" type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": faq.map(item => ({
        "@type": "Question",
        "name": item.q,
        "acceptedAnswer": { "@type": "Answer", "text": item.a },
      })),
    })} />
  )}

  <div class="max-w-4xl mx-auto px-4 py-8">
    <!-- Breadcrumb -->
    <nav class="text-sm text-gray-500 mb-6">
      <a href="/" class="hover:text-primary-600">Home</a>
      <span class="mx-2">‚Ä∫</span>
      <a href="/blog/" class="hover:text-primary-600">Blog</a>
      <span class="mx-2">‚Ä∫</span>
      <span class="text-gray-700">{title}</span>
    </nav>

    <!-- Article Header -->
    <header class="mb-8">
      <div class="flex items-center gap-3 mb-3">
        <span class="px-3 py-1 bg-primary-50 text-primary-700 text-xs font-medium rounded-full uppercase">{category}</span>
        <time datetime={publishDate} class="text-sm text-gray-500">{formattedDate}</time>
      </div>
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900 leading-tight">{title}</h1>
      <p class="text-lg text-gray-600 mt-3">{description}</p>
    </header>

    <!-- AdSense: Top -->
    <AdSense slot="top" />

    <!-- Table of Contents -->
    {tocHeadings.length > 0 && (
      <nav class="bg-gray-50 rounded-xl p-5 mb-8 border border-gray-100">
        <h2 class="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-3">üìë Table of Contents</h2>
        <ul class="space-y-2">
          {tocHeadings.map((h) => (
            <li>
              <a href={`#${h.slug}`} class="text-primary-600 hover:text-primary-800 text-sm hover:underline">
                {h.text}
              </a>
            </li>
          ))}
        </ul>
      </nav>
    )}

    <!-- AdSense: After TOC -->
    <AdSense slot="after-toc" />

    <!-- Article Content -->
    <article class="prose prose-lg max-w-none prose-headings:scroll-mt-20 prose-a:text-primary-600 prose-a:no-underline hover:prose-a:underline">
      <slot />
    </article>

    <!-- AdSense: Mid -->
    <AdSense slot="mid" />

    <!-- FAQ Section -->
    {faq && faq.length > 0 && (
      <section class="mt-12 bg-blue-50 rounded-xl p-6 border border-blue-100">
        <h2 id="faq" class="text-2xl font-bold text-gray-900 mb-6">‚ùì Frequently Asked Questions</h2>
        <div class="space-y-5">
          {faq.map((item) => (
            <details class="bg-white rounded-lg p-4 shadow-sm border border-blue-100 group">
              <summary class="font-semibold text-gray-900 cursor-pointer list-none flex items-center justify-between">
                {item.q}
                <span class="text-primary-600 group-open:rotate-180 transition-transform">‚ñº</span>
              </summary>
              <p class="mt-3 text-gray-700 leading-relaxed">{item.a}</p>
            </details>
          ))}
        </div>
      </section>
    )}

    <!-- AdSense: Before Footer -->
    <AdSense slot="before-faq" />

    <!-- Tags -->
    {tags && tags.length > 0 && (
      <div class="mt-8 flex flex-wrap gap-2">
        {tags.map(tag => (
          <span class="px-3 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">{tag}</span>
        ))}
      </div>
    )}

    <!-- Back to Blog -->
    <div class="mt-12 pt-8 border-t border-gray-200 text-center">
      <a href="/blog/" class="inline-flex items-center gap-2 text-primary-600 hover:text-primary-800 font-medium">
        ‚Üê Back to All Articles
      </a>
    </div>
  </div>
</BaseLayout>
